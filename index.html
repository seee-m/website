<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>
    <!-- Mobile browser chrome color -->
    <meta name="theme-color" content="#000108">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="directory-component.css">
</head>
<body>
    <div class="container">
        <!-- Background and work images -->
        <img id="background" class="background" alt="Background">
        <div id="workContainer" class="work"></div>
        
        <!-- Header with title and navigation -->
        <header class="header">
            <div class="box title-box">
                <div class="title-box-top">
                    <span class="title">[c-m] connor macdonald <br> applied artist & designer</span>

 
                </div>
                
                <div class="title-box-bottom">
                    <button id="directoryToggle" class="nav-link">[directory]</button>
                    <div style="display: flex; gap: 10px; margin-left: auto;">
                        <button id="bgToggle" class="nav-link mono-text-button">‚èª</button>
                        <button id="reroll" class="nav-link">[randomise]</button>
                    </div>
                </div>
            </div>

            <div class="box controls-box">
                <p class="readout" id="fileReadout"></p>
            </div>
        </header>
    </div>

    <script>
        // Configuration
        const IMAGE_PATH = '/media/background/';
        const WORK_PATH = '/media/work/';
        const TYPING_SPEED = 50; // milliseconds per character
        
        // State
        let backgrounds = [];
        let works = [];
        let currentWorkFile = '';
        let typewriterTimeout;
        let lastBackground = null;
        let lastWork = null;
        
        // Utility
        const random = (array) => array[Math.floor(Math.random() * array.length)];
        
        // Random selection excluding last pick
        function randomExcluding(array, exclude) {
            if (array.length <= 1) return array[0];
            let item;
            do {
                item = array[Math.floor(Math.random() * array.length)];
            } while (item === exclude);
            return item;
        }
        
        // Load media list from text file (images and videos)
        async function loadImages(filename, path) {
            try {
                const response = await fetch(filename);
                const text = await response.text();
                return text
                    .split('\n')
                    .filter(line => line.trim())
                    .map(img => path + img);
            } catch (error) {
                console.error(`Failed to load ${filename}:`, error);
                return [];
            }
        }

        // Check if file is a video based on extension
        function isVideo(filename) {
            return filename.toLowerCase().endsWith('.mp4') || filename.toLowerCase().endsWith('.webm');
        }
        
        // Typewriter effect
        function typeWriter(text, element) {
            // Clear any existing timeout
            if (typewriterTimeout) {
                clearTimeout(typewriterTimeout);
            }
            
            element.textContent = '';
            let index = 0;
            
            function type() {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    index++;
                    typewriterTimeout = setTimeout(type, TYPING_SPEED);
                }
            }
            
            type();
        }
        
        // Update displayed images/videos
        function refresh() {
            if (backgrounds.length) {
                const bgPath = randomExcluding(backgrounds, lastBackground);
                lastBackground = bgPath;
                document.getElementById('background').src = bgPath;
            }
            if (works.length) {
                const workPath = randomExcluding(works, lastWork);
                lastWork = workPath;

                // Clear previous work media
                const workContainer = document.getElementById('workContainer');
                workContainer.innerHTML = '';

                // Create appropriate element (video or image)
                let mediaElement;
                if (isVideo(workPath)) {
                    mediaElement = document.createElement('video');
                    mediaElement.src = workPath;
                    mediaElement.autoplay = true;
                    mediaElement.loop = true;
                    mediaElement.muted = true;
                    mediaElement.playsInline = true;
                    mediaElement.alt = 'Work';
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = workPath;
                    mediaElement.alt = 'Work';
                }

                workContainer.appendChild(mediaElement);

                // Extract filename from path and update readout
                currentWorkFile = workPath.replace(WORK_PATH, '');
                const readoutElement = document.getElementById('fileReadout');
                typeWriter(currentWorkFile, readoutElement);
            }
        }
        
        // Initialize
        async function init() {
            backgrounds = await loadImages('/media/background/background.txt', IMAGE_PATH);
            works = await loadImages('/media/work/work.txt', WORK_PATH);
            refresh();
        }

        // Events
        document.getElementById('reroll').addEventListener('click', refresh);

        // Background toggle
        let backgroundVisible = true;
        document.getElementById('bgToggle').addEventListener('click', function() {
            const bgElement = document.getElementById('background');
            backgroundVisible = !backgroundVisible;
            bgElement.style.display = backgroundVisible ? 'block' : 'none';
        });
        
        // Position work media below controls-box on mobile only
        function positionWorkImage() {
            const workContainer = document.getElementById('workContainer');

            if (window.innerWidth <= 600 || window.innerHeight > window.innerWidth) {
                const controlsBox = document.querySelector('.controls-box');

                if (controlsBox && workContainer) {
                    const controlsBoxRect = controlsBox.getBoundingClientRect();
                    const controlsBoxBottom = controlsBoxRect.bottom;

                    // Position work container so its top aligns with controls-box bottom plus 1.5rem spacing
                    workContainer.style.top = (controlsBoxBottom + 24) + 'px';  // 24px = 1.5rem
                    workContainer.style.bottom = 'auto';
                }
            } else {
                // Reset positioning for desktop
                if (workContainer) {
                    workContainer.style.top = '';
                    workContainer.style.bottom = '';
                }
            }
        }
        
        // Run on load and resize
        window.addEventListener('load', positionWorkImage);
        
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(positionWorkImage, 150);
        });
        
        // Update refresh to reposition after image changes
        const originalRefresh = refresh;
        refresh = function() {
            originalRefresh();
            setTimeout(positionWorkImage, 100);
        };
        
        // Start
        init();
    </script>
    <script src="directory-component.js"></script>
</body>
</html>