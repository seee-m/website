<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="stylesheet" href="music.css">
    <script src="https://cdn.jsdelivr.net/npm/audiomotion-analyzer@4"></script>
</head>

<body>
    <div id="visualizer"></div>
    
    <header class="header">
        <div class="title-box">
            <p class="title" id="pathDisplay">/MUSIC</p>
            <br>
            <button onclick="window.location.href='../links/links.html'" class="back-link">[BACK]</button>
            <button id="playPauseBtn" class="back-link">[PLAY]</button>
            <button id="hideShowBtn" class="back-link">[HIDE]</button>
        </div>

        <div class="controls-box">
            <p class="now-playing" id="nowPlaying">NO FILE LOADED</p>
            <p class="time-display" id="timeDisplay">0:00 / 0:00</p>
        </div>
        
        <div class="playlist-box">
            <div class="scroll-arrow scroll-arrow-up" id="scrollUpArrow">▲</div>
            <div class="playlist-scroll" id="playlistScroll">
                <ul class="track-list" id="trackList">
                    <!-- Tracks will be loaded here -->
                </ul>
            </div>
            <div class="scroll-arrow scroll-arrow-down" id="scrollDownArrow">▼</div>
        </div>
    </header>

    <audio id="audioPlayer"></audio>

    <script>
        // State
        let currentPath = '../../media/music';
        let currentFiles = [];
        let currentTrackIndex = -1;
        let isPlaying = false;

        // Audio visualization
        let audioMotion;
        let audioContext;

        // Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const trackList = document.getElementById('trackList');
        const nowPlaying = document.getElementById('nowPlaying');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const hideShowBtn = document.getElementById('hideShowBtn');
        const timeDisplay = document.getElementById('timeDisplay');
        const pathDisplay = document.getElementById('pathDisplay');
        const visualizerContainer = document.getElementById('visualizer');
        const controlsBox = document.querySelector('.controls-box');
        const playlistBox = document.querySelector('.playlist-box');
        const playlistScroll = document.getElementById('playlistScroll');
        const scrollUpArrow = document.getElementById('scrollUpArrow');
        const scrollDownArrow = document.getElementById('scrollDownArrow');

        // Update scroll arrows
        function updateScrollArrows() {
            const scrollTop = playlistScroll.scrollTop;
            const scrollHeight = playlistScroll.scrollHeight;
            const clientHeight = playlistScroll.clientHeight;
            
            scrollUpArrow.classList.toggle('visible', scrollTop > 0);
            scrollDownArrow.classList.toggle('visible', scrollTop + clientHeight < scrollHeight - 1);
        }

        // Initialize AudioMotion analyzer with Fairlight CMI style
        function initAudioContext() {
            if (!audioMotion) {
                audioMotion = new AudioMotionAnalyzer(visualizerContainer, {
                    source: audioPlayer,
                    mode: 10, // Line graph mode - looks like oscilloscope
                    gradient: 'classic', // Will override with custom
                    showBgColor: true,
                    bgAlpha: 1,
                    overlay: true,
                    showPeaks: false,
                    showScaleX: false,
                    showScaleY: false,
                    reflexRatio: 0,
                    fillAlpha: 0,
                    lineWidth: 1.5,
                    frequencyScale: 'linear',
                    smoothing: 0.7,
                    minFreq: 20,
                    maxFreq: 16000
                });
                
                // Create custom Fairlight-style gradient
                audioMotion.registerGradient('fairlight', {
                    bgColor: '#000',
                    colorStops: [
                        { pos: 0, color: '#00ff99' },
                        { pos: 1, color: '#00ff99' }
                    ]
                });
                
                audioMotion.gradient = 'fairlight';
                audioContext = audioMotion.audioCtx;
            }
        }

        // Initialize
        async function init() {
            await loadFiles();
            setupEventListeners();
        }

        async function loadFiles() {
            try {
                console.log('Loading from:', currentPath);
                
                // Load the manifest
                const response = await fetch('music-manifest.json');
                const manifest = await response.json();
                
                const items = [];
                
                // Determine which level we're at
                if (currentPath === '../../media/music') {
                    // Root level - show folders and root files
                    manifest.folders.forEach(folder => {
                        items.push({ name: folder.name, type: 'folder' });
                    });
                    manifest.files.forEach(file => {
                        items.push({ name: file, type: 'audio' });
                    });
                } else {
                    // Inside a folder
                    const folderName = currentPath.split('/').pop();
                    const folder = manifest.folders.find(f => f.name === folderName);
                    
                    if (folder) {
                        folder.files.forEach(file => {
                            items.push({ name: file, type: 'audio' });
                        });
                    }
                }
                
                console.log('Loaded items:', items);
                currentFiles = items;
                renderTracks();
            } catch (error) {
                console.error('Error loading files:', error);
                trackList.innerHTML = '<li class="track-item">ERROR LOADING FILES</li>';
            }
        }

        async function folderHasMp3s(folderPath) {
            try {
                const response = await fetch(`${folderPath}/`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'));
                
                for (const link of links) {
                    const href = link.getAttribute('href');
                    if (href && href.toLowerCase().endsWith('.mp3')) {
                        return true;
                    }
                    if (href && href.endsWith('/') && href !== '../') {
                        // Recursively check subfolders
                        const name = decodeURIComponent(href.replace(/\/$/, ''));
                        const hasMp3s = await folderHasMp3s(`${folderPath}/${name}`);
                        if (hasMp3s) return true;
                    }
                }
                return false;
            } catch {
                return false;
            }
        }

        function renderTracks() {
            trackList.innerHTML = '';
            
            // Update path display
            pathDisplay.textContent = '/' + currentPath.toUpperCase();
            
            // Add parent directory option if not at root
            if (currentPath !== '../../media/music') {
                const li = document.createElement('li');
                li.className = 'track-item parent-folder';
                li.innerHTML = '<span class="track-name">.. (PARENT)</span><span class="track-type">&lt;DIR&gt;</span>';
                li.onclick = () => navigateUp();
                trackList.appendChild(li);
            }

            currentFiles.forEach((item, index) => {
                const li = document.createElement('li');
                
                if (item.type === 'folder') {
                    li.className = 'track-item folder-item';
                    li.innerHTML = `<span class="track-name">${item.name}</span><span class="track-type">&lt;DIR&gt;</span>`;
                    li.onclick = () => navigateInto(item.name);
                } else if (item.type === 'audio') {
                    li.className = 'track-item audio';
                    li.innerHTML = `<span class="track-name">${item.name}</span>`;
                    // Calculate audio-only index
                    const audioFiles = currentFiles.filter(f => f.type === 'audio');
                    const audioIndex = audioFiles.findIndex(f => f.name === item.name);
                    li.onclick = () => playFile(audioIndex);
                }
                
                trackList.appendChild(li);
            });
            
            // Update scroll arrows after content changes
            setTimeout(updateScrollArrows, 100);
        }

        async function navigateInto(folderName) {
            currentPath = `${currentPath}/${folderName}`;
            await loadFiles();
        }

        async function navigateUp() {
            const parts = currentPath.split('/');
            parts.pop();
            currentPath = parts.join('/') || '../../media/music';
            await loadFiles();
        }

        function selectFile(index) {
            const items = document.querySelectorAll('.track-item.audio');
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });
        }

        function playFile(index) {
            selectFile(index);
            
            const audioFiles = currentFiles.filter(f => f.type === 'audio');
            currentTrackIndex = index;
            const file = audioFiles[index];
            
            if (file) {
                // Initialize audio context on first play
                if (!audioContext) {
                    initAudioContext();
                }
                
                audioPlayer.src = `${currentPath}/${file.name}`;
                audioPlayer.currentTime = 0; // Reset to start
                audioPlayer.play();
                isPlaying = true;
                
                nowPlaying.textContent = file.name.toUpperCase();
                playPauseBtn.textContent = '[PAUSE]';
                updatePlayingState();
            }
        }

        function updatePlayingState() {
            const items = document.querySelectorAll('.track-item.audio');
            const audioFiles = currentFiles.filter(f => f.type === 'audio');
            const currentFile = audioFiles[currentTrackIndex];
            
            items.forEach((item, i) => {
                const itemName = item.querySelector('.track-name').textContent;
                item.classList.toggle('playing', currentFile && itemName === currentFile.name && !audioPlayer.paused);
            });
        }

        function setupEventListeners() {
            playPauseBtn.onclick = () => {
                if (isPlaying) {
                    audioPlayer.pause();
                    isPlaying = false;
                    playPauseBtn.textContent = '[PLAY]';
                    updatePlayingState();
                } else {
                    if (currentTrackIndex >= 0) {
                        audioPlayer.play();
                        isPlaying = true;
                        playPauseBtn.textContent = '[PAUSE]';
                        updatePlayingState();
                    } else {
                        const audioFiles = currentFiles.filter(f => f.type === 'audio');
                        if (audioFiles.length > 0) {
                            playFile(0);
                        }
                    }
                }
            };

            hideShowBtn.onclick = () => {
                const isHidden = controlsBox.style.display === 'none';
                if (isHidden) {
                    controlsBox.style.display = 'flex';
                    playlistBox.style.display = 'block';
                    hideShowBtn.textContent = '[HIDE]';
                } else {
                    controlsBox.style.display = 'none';
                    playlistBox.style.display = 'none';
                    hideShowBtn.textContent = '[SHOW]';
                }
            };

            audioPlayer.addEventListener('timeupdate', () => {
                const current = formatTime(audioPlayer.currentTime);
                const total = formatTime(audioPlayer.duration);
                timeDisplay.textContent = `${current} / ${total}`;
            });

            playlistScroll.addEventListener('scroll', updateScrollArrows);

            audioPlayer.addEventListener('ended', () => {
                const audioFiles = currentFiles.filter(f => f.type === 'audio');
                if (currentTrackIndex < audioFiles.length - 1) {
                    playFile(currentTrackIndex + 1);
                } else {
                    isPlaying = false;
                    playPauseBtn.textContent = '[PLAY]';
                }
            });

            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                updatePlayingState();
            });

            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                updatePlayingState();
            });

            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    playPauseBtn.click();
                }
            });
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Start the app
        init();
    </script>
</body>
</html>